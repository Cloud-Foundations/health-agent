#! /bin/bash --posix

### BEGIN INIT INFO
# Provides:		health-agent
# Required-Start:	$local_fs $network $syslog
# Required-Stop:	$local_fs $network $syslog
# Default-Start:	2 3 4 5
# Default-Stop:		0 1 6
# Short-Description:	System health agent
### END INIT INFO

set -e

# /etc/init.d/health-agent: start and stop the system health daemon

test -x /usr/local/bin/health-agent || exit 0

umask 022

. /lib/lsb/init-functions

export PATH="${PATH:+$PATH:}/usr/local/bin:/usr/local/sbin:/usr/sbin:/sbin"
readonly pidfile="/var/run/health-agent.pid"

case "$1" in
  start)
	log_daemon_msg "Starting system health agent" "health-agent" || true
	/usr/local/bin/health-agent < /dev/null &> /dev/null &
	;;
  stop)
	log_daemon_msg "Stopping system health agent" "health-agent" || true
	if [ -s "$pidfile" ]; then
	    kill -TERM $(cat "$pidfile")
	else
	    killall -o 1s health-agent
	fi
	;;

  reload|force-reload)
	kill -HUP $(cat "$pidfile")
	;;

  restart)
	kill -HUP $(cat "$pidfile")
	;;

  start-if-down)
	[ -s "$pidfile" ] && kill -0 $(cat "$pidfile") &> /dev/null && exit
	killall -o 1s health-agent || true
	log_daemon_msg "Starting system health agent" "health-agent" || true
	/usr/local/bin/health-agent < /dev/null &> /dev/null &
	;;

  *)
	log_action_msg "Usage: /etc/init.d/health-agent {start|stop|reload|force-reload|restart}" || true
	exit 1
esac

exit 0
